name: Grant Private Repo Access

on:
  issues:
    types: [opened]

jobs:
  grant:
    runs-on: ubuntu-latest

    steps:
      # STEP 0 — extract username
      - name: Extract GitHub username
        id: extract
        run: |
          BODY="${{ github.event.issue.body }}"

          USERNAME=$(printf "%s\n" "$BODY" \
            | grep -i "github username" \
            | sed 's/.*github username[^a-zA-Z0-9_-]*//' \
            | tr -d '\r' \
            | xargs)

          echo "username=$USERNAME" >> $GITHUB_OUTPUT

      # STEP 1 — show the raw issue body
      - name: Debug issue body
        run: |
          echo "----- ISSUE BODY START -----"
          echo "${{ github.event.issue.body }}"
          echo "----- ISSUE BODY END -----"

      # STEP 2 — show what the extract step produced
      - name: Debug extracted username
        run: |
          echo "Extracted output = '${{ steps.extract.outputs.username }}'"

      # STEP 3 — invite user (final step)
      - name: Invite user to private repo
        env:
          PAT: ${{ secrets.ACCESS_PAT }}
          USERNAME: ${{ steps.extract.outputs.username }}
        run: |
          echo "Inviting user: '$USERNAME'"

          if [ -z "$USERNAME" ]; then
            echo "No username found"
            exit 1
          fi

          curl -i -X PUT \
            -H "Authorization: Bearer $PAT" \
            -H "Accept: application/vnd.github+json" \
            -H "Content-Type: application/json" \
            https://api.github.com/repos/kaosorg/test-access-private/collaborators/$USERNAME \
            -d '{"permission":"pull"}'

