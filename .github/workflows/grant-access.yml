name: Grant Private Repo Access

on:
  issues:
    types: [opened]

jobs:
  grant:
    runs-on: ubuntu-latest

    permissions:
      issues: write
      contents: read

    steps:
      - name: Extract GitHub username
        id: extract
        run: |
          BODY="${{ github.event.issue.body }}"

          USERNAME=$(printf "%s\n" "$BODY" \
            | sed -n '
                /^### GitHub Username/{
                  :a
                  n
                  /^[[:space:]]*$/ba
                  p
                }' \
            | tr -d '`' \
            | xargs)

          if [ -z "$USERNAME" ]; then
            echo "username=" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "username=$USERNAME" >> $GITHUB_OUTPUT

      - name: Validate GitHub user
        env:
          USERNAME: ${{ steps.extract.outputs.username }}
        run: |
          if [ -z "$USERNAME" ]; then
            exit 1
          fi

          STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            https://api.github.com/users/$USERNAME)

          if [ "$STATUS" != "200" ]; then
            echo "::error::Username $USERNAME is not a valid GitHub user" && exit 1
            curl -s -X PATCH \
              -H "Authorization: Bearer $PAT" \
              -H "Accept: application/vnd.github+json" \
              https://api.github.com/repos/kaosorg/test-access-public/issues/$ISSUE_NUMBER \
              -d '{
                "body": "(Bad username)",
                "state": "closed",
                "locked": true
              }' \
              > /dev/null
          fi

      # 3️⃣ Invite user to private repo
      - name: Invite to private repo
        env:
          PAT: ${{ secrets.ACCESS_PAT }}
          USERNAME: ${{ steps.extract.outputs.username }}
        run: |
          curl -s -X PUT \
            -H "Authorization: Bearer $PAT" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/kaosorg/test-access-private/collaborators/$USERNAME \
            -d '{"permission":"pull"}' \
            > /dev/null

      # 4️⃣ REDACT issue body immediately
      - name: Redact issue
        env:
          PAT: ${{ secrets.ACCESS_PAT }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          curl -s -X PATCH \
            -H "Authorization: Bearer $PAT" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/kaosorg/test-access-public/issues/$ISSUE_NUMBER \
            -d '{
              "body": "(redacted — access request processed)",
              "state": "closed",
              "locked": true
            }' \
            > /dev/null
