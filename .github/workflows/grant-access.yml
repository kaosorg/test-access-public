name: Grant Private Repo Access

on:
  issues:
    types: [opened]

jobs:
  grant:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Extract GitHub username from issue body
      - name: Extract GitHub username
        id: extract
        run: |
          BODY="${{ github.event.issue.body }}"

          # Handles usernames on the line after "### GitHub Username" and skips blank lines
          USERNAME=$(printf "%s\n" "$BODY" \
            | sed -n '
                /^### GitHub Username/{
                  :a
                  n
                  /^[[:space:]]*$/ba
                  p
                }' \
            | xargs)

          echo "username=$USERNAME" >> $GITHUB_OUTPUT

      # 2️⃣ Debug extracted username (optional)
      - name: Debug extracted username
        run: |
          echo "Extracted username = '${{ steps.extract.outputs.username }}'"

      # 3️⃣ Invite user to private repo
      - name: Invite user to private repo
        env:
          PAT: ${{ secrets.ACCESS_PAT_CLASSIC }}
          USERNAME: ${{ steps.extract.outputs.username }}
        run: |
          if [ -z "$USERNAME" ]; then
            echo "No username found, stopping workflow."
            exit 1
          fi

          echo "Inviting user: $USERNAME"

          curl -i -X PUT \
            -H "Authorization: Bearer $PAT" \
            -H "Accept: application/vnd.github+json" \
            -H "Content-Type: application/json" \
            https://api.github.com/repos/kaosorg/test-access-private/collaborators/$USERNAME \
            -d '{"permission":"pull"}'

      # 4️⃣ Comment confirmation (optional)
      - name: Comment confirmation
        env:
          PAT: ${{ secrets.ACCESS_PAT_CLASSIC }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          USERNAME: ${{ steps.extract.outputs.username }}
        run: |
          curl -X POST \
            -H "Authorization: Bearer $PAT" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/kaosorg/test-access-public/issues/$ISSUE_NUMBER/comments \
            -d "{\"body\":\"✅ @${USERNAME}, your request has been processed and the issue will now be deleted.\"}"

      # 5️⃣ Delete the public issue to hide username
      - name: Delete public issue
        env:
          PAT: ${{ secrets.ACCESS_PAT_CLASSIC }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          curl -X PATCH \
            -H "Authorization: Bearer $PAT" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/kaosorg/test-access-public/issues/$ISSUE_NUMBER \
            -d '{"body":"(redacted — request processed)","state":"closed","locked":true}'
